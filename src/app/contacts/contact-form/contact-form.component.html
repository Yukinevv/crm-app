<div class="container mt-4">
  <h2 class="mb-4">{{ editId ? 'Edycja kontaktu' : 'Nowy kontakt' }}</h2>

  <button type="submit" class="btn btn-primary" [disabled]="form.invalid">Zapisz</button>
  <button type="button" class="btn btn-secondary ml-2" (click)="router.navigate(['/contacts'])">
    Anuluj
  </button>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="form-row mt-4">
      <div class="form-group col-md-6">
        <label>Imię</label>
        <input formControlName="firstName" class="form-control">
        <div *ngIf="form.get('firstName')?.errors?.['required'] && form.get('firstName')?.touched"
             class="text-danger small">
          Pole jest wymagane
        </div>
      </div>
      <div class="form-group col-md-6">
        <label>Nazwisko</label>
        <input formControlName="lastName" class="form-control">
        <div *ngIf="form.get('lastName')?.errors?.['required'] && form.get('lastName')?.touched"
             class="text-danger small">
          Pole jest wymagane
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Firma</label>
      <input formControlName="company" class="form-control">
    </div>
    <div class="form-group">
      <label>Stanowisko</label>
      <input formControlName="position" class="form-control">
    </div>
    <div class="form-group">
      <label>Telefon</label>
      <input formControlName="phone" class="form-control">
    </div>

    <div class="form-group">
      <label>Email</label>
      <input type="email" formControlName="email" class="form-control">
      <div *ngIf="form.get('email')?.errors?.['required'] && form.get('email')?.touched"
           class="text-danger small">
        Pole jest wymagane
      </div>
      <div *ngIf="form.get('email')?.errors?.['email'] && form.get('email')?.touched"
           class="text-danger small">
        Nieprawidłowy format adresu email
      </div>
    </div>

    <div class="form-group mb-4">
      <label>Powiąż z kontem użytkownika</label>
      <div class="input-group">
        <input [(ngModel)]="searchEmail" [ngModelOptions]="{standalone: true}" placeholder="Email użytkownika"
               class="form-control">
        <button type="button" class="btn btn-outline-secondary" (click)="searchUser()">Wyszukaj</button>
      </div>
      <div *ngIf="foundUser" class="mt-2">
        <span>Znaleziono: {{ foundUser.email }}</span>
        <button type="button" class="btn btn-sm btn-success ms-2" (click)="linkUser()">Powiąż</button>
      </div>
      <div *ngIf="form.get('linkedUid')?.value" class="mt-2">
        <small>Powiązany UID: {{ form.get('linkedUid')?.value }}</small>
      </div>
      <input type="hidden" formControlName="linkedUid">
    </div>

    <div class="form-group">
      <label>Adres</label>
      <input formControlName="address" class="form-control">
    </div>
    <div class="form-group">
      <label>Notatki</label>
      <textarea formControlName="notes" rows="3" class="form-control"></textarea>
    </div>
    <div class="form-group">
      <label>Tagi (oddzielaj przecinkami)</label>
      <input formControlName="tags" placeholder="VIP, Prospekt, …" class="form-control">
    </div>

    <div class="form-row">
      <div class="form-group col-md-4">
        <label>Status</label>
        <select formControlName="status" class="form-control">
          <option value="">-- wybierz --</option>
          <option *ngFor="let s of ['Nowy','Kontaktowany','Klient','Nieaktywny']" [value]="s">
            {{ s }}
          </option>
        </select>
      </div>
      <div class="form-group col-md-4">
        <label>Data dodania</label>
        <input type="datetime-local" formControlName="createdAt" class="form-control">
      </div>
      <div class="form-group col-md-4">
        <label>Region</label>
        <input formControlName="region" placeholder="np. Europa" class="form-control">
      </div>
    </div>

    <div class="form-group">
      <label>Źródło lejka</label>
      <input formControlName="source" placeholder="np. Rekomendacja" class="form-control">
    </div>

    <div class="form-row">
      <div class="form-group col-md-4">
        <label>Firma (powiązana)</label>
        <select formControlName="companyId" class="form-control">
          <option value="">-- brak --</option>
          <option *ngFor="let c of contactsList" [value]="c.id" [disabled]="c.id === editId">
            {{ c.firstName }} {{ c.lastName }}<span *ngIf="c.company"> – {{ c.company }}</span>
          </option>
        </select>
      </div>
      <div class="form-group col-md-4">
        <label>Przełożony</label>
        <select formControlName="managerId" class="form-control">
          <option value="">-- brak --</option>
          <option *ngFor="let c of contactsList" [value]="c.id" [disabled]="c.id === editId">
            {{ c.firstName }} {{ c.lastName }}
          </option>
        </select>
      </div>
      <div class="form-group col-md-4">
        <label>Decydent</label>
        <select formControlName="decisionMakerId" class="form-control">
          <option value="">-- brak --</option>
          <option *ngFor="let c of contactsList" [value]="c.id" [disabled]="c.id === editId">
            {{ c.firstName }} {{ c.lastName }}
          </option>
        </select>
      </div>
    </div>

    <button type="submit" class="btn btn-primary" [disabled]="form.invalid">Zapisz</button>
    <button type="button" class="btn btn-secondary ml-2" (click)="router.navigate(['/contacts'])">
      Anuluj
    </button>
  </form>

  <!-- PANEL AKTYWNOŚCI: wyświetlany tylko podczas edycji istniejącego kontaktu -->
  <app-contact-activity *ngIf="editId" [contactId]="editId"></app-contact-activity>
</div>
